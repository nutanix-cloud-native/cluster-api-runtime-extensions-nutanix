# Copyright 2024 Nutanix. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- ../../../bases/eks/clusterclass

sortOptions:
  order: fifo

namePrefix: eks-

configurations:
  - kustomizeconfig.yaml

patches:
  - target:
      kind: ClusterClass
    patch: |-
      - op: "add"
        path: "/spec/patches"
        value:
          - name: "cluster-config"
            external:
              generateExtension: "eksclusterv4configpatch-gp.cluster-api-runtime-extensions-nutanix"
              discoverVariablesExtension: "eksclusterconfigvars-dv.cluster-api-runtime-extensions-nutanix"
          - name: "worker-config"
            external:
              generateExtension: "eksworkerv4configpatch-gp.cluster-api-runtime-extensions-nutanix"
              discoverVariablesExtension: "eksworkerconfigvars-dv.cluster-api-runtime-extensions-nutanix"
          - name: identityRef
            definitions:
              - jsonPatches:
                  - op: add
                    path: /spec/template/spec/identityRef
                    value:
                      kind: AWSClusterControllerIdentity
                      name: default
                selector:
                  apiVersion: controlplane.cluster.x-k8s.io/v1beta2
                  kind: AWSManagedControlPlaneTemplate
                  matchResources:
                    controlPlane: true
            description: AWSClusterStaticIdentity identityRef to use when creating the cluster
  - target:
      kind: AWSMachineTemplate
    patch: |-
      - op: "add"
        path: "/spec/template/spec/sshKeyName"
        value: ""
  - target:
      kind: AWSMachineTemplate
      name: quick-start-worker-machinetemplate
    patch: |-
      - op: "add"
        path: "/spec/template/spec/instanceType"
        value: "PLACEHOLDER"
