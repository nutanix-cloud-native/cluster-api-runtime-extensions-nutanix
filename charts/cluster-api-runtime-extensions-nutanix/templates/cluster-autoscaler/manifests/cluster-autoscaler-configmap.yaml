# Copyright 2024 Nutanix. All rights reserved.
# SPDX-License-Identifier: Apache-2.0

#=================================================================
#                 DO NOT EDIT THIS FILE
#  IT HAS BEEN GENERATED BY /hack/addons/cluster-autoscaler.sh
#=================================================================
apiVersion: v1
data:
  cluster-autoscaler.yaml: |
    apiVersion: policy/v1
    kind: PodDisruptionBudget
    metadata:
      labels:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
        helm.sh/chart: cluster-autoscaler-9.37.0
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    spec:
      maxUnavailable: 1
      selector:
        matchLabels:
          app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
          app.kubernetes.io/name: clusterapi-cluster-autoscaler
    ---
    apiVersion: v1
    automountServiceAccountToken: true
    kind: ServiceAccount
    metadata:
      labels:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
        helm.sh/chart: cluster-autoscaler-9.37.0
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      labels:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
        helm.sh/chart: cluster-autoscaler-9.37.0
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    rules:
    - apiGroups:
      - ""
      resources:
      - configmaps
      verbs:
      - create
    - apiGroups:
      - ""
      resourceNames:
      - cluster-autoscaler-status
      resources:
      - configmaps
      verbs:
      - delete
      - get
      - update
    - apiGroups:
      - cluster.x-k8s.io
      resources:
      - machinedeployments
      - machinepools
      - machines
      - machinesets
      verbs:
      - get
      - list
      - update
      - watch
    - apiGroups:
      - cluster.x-k8s.io
      resources:
      - machinedeployments/scale
      - machinepools/scale
      verbs:
      - get
      - patch
      - update
    - apiGroups:
      - coordination.k8s.io
      resources:
      - leases
      verbs:
      - create
    - apiGroups:
      - coordination.k8s.io
      resourceNames:
      - cluster-autoscaler
      resources:
      - leases
      verbs:
      - get
      - update
    ---
    apiVersion: rbac.authorization.k8s.io/v1
    kind: RoleBinding
    metadata:
      labels:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
        helm.sh/chart: cluster-autoscaler-9.37.0
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    roleRef:
      apiGroup: rbac.authorization.k8s.io
      kind: Role
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
    subjects:
    - kind: ServiceAccount
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    ---
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
        helm.sh/chart: cluster-autoscaler-9.37.0
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    spec:
      ports:
      - name: http
        port: 8085
        protocol: TCP
        targetPort: 8085
      selector:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
      type: ClusterIP
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
        app.kubernetes.io/managed-by: Helm
        app.kubernetes.io/name: clusterapi-cluster-autoscaler
        helm.sh/chart: cluster-autoscaler-9.37.0
      name: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
      namespace: '{{ `{{ .Cluster.Namespace }}` }}'
    spec:
      replicas: 1
      revisionHistoryLimit: 10
      selector:
        matchLabels:
          app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
          app.kubernetes.io/name: clusterapi-cluster-autoscaler
      template:
        metadata:
          labels:
            app.kubernetes.io/instance: 'ca-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
            app.kubernetes.io/name: clusterapi-cluster-autoscaler
        spec:
          containers:
          - command:
            - ./cluster-autoscaler
            - --cloud-provider=clusterapi
            - --namespace=kube-system
            - --node-group-auto-discovery=clusterapi:clusterName='{{ `{{ .Cluster.Name }}` }}',namespace='{{ `{{ .Cluster.Namespace }}` }}'
            - --kubeconfig=/cluster/kubeconfig
            - --clusterapi-cloud-config-authoritative
            - --enforce-node-group-min-size=true
            - --logtostderr=true
            - --stderrthreshold=info
            - --v=4
            env:
            - name: POD_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: SERVICE_ACCOUNT
              valueFrom:
                fieldRef:
                  fieldPath: spec.serviceAccountName
            image: registry.k8s.io/autoscaling/cluster-autoscaler:v1.30.0
            imagePullPolicy: IfNotPresent
            livenessProbe:
              httpGet:
                path: /health-check
                port: 8085
            name: clusterapi-cluster-autoscaler
            ports:
            - containerPort: 8085
            resources: {}
            volumeMounts:
            - mountPath: /cluster
              name: kubeconfig
              readOnly: true
          dnsPolicy: ClusterFirst
          priorityClassName: system-cluster-critical
          serviceAccountName: 'cluster-autoscaler-{{ `{{ index .Cluster.Annotations "caren.nutanix.com/cluster-uuid" }}` }}'
          tolerations:
          - effect: NoSchedule
            key: node-role.kubernetes.io/control-plane
          volumes:
          - name: kubeconfig
            secret:
              items:
              - key: value
                path: kubeconfig
              secretName: '{{ `{{ .Cluster.Name }}` }}-kubeconfig'
kind: ConfigMap
metadata:
  creationTimestamp: null
  name: '{{ .Values.hooks.clusterAutoscaler.crsStrategy.defaultInstallationConfigMap.name
    }}'
